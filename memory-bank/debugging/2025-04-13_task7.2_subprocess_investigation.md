# Debug Log: Task 7.2 - Subprocess Invocation Investigation (2025-04-13 Session 2)

**Objective:** Diagnose why the Dramatiq worker fails to process messages when launched via `subprocess.Popen` from test scripts/fixtures, but works when run via `tox exec`.

**Plan:** Follow steps outlined in `PLANNING_step_7.2.5_subprocess_debug.md`.

**Steps Taken & Findings:**

1.  **Environment & Context Comparison:**
    *   Added detailed environment logging (env vars, python path, cwd, uid/gid) to `ops-core/src/ops_core/tasks/worker.py` startup.
    *   Improved subprocess stdout/stderr capture in `test_dramatiq_worker.py`.
    *   Ran worker via `tox exec` and captured logs.
    *   Ran worker via `test_dramatiq_worker.py` (using `tox exec`) and captured logs.
    *   **Comparison:** Core environment (Python exe, path, CWD, user) identical. Key difference was environment variables passed: `test_dramatiq_worker.py` correctly removed `DRAMATIQ_TESTING` but initially passed empty strings for LLM config vars due to how `os.getenv` defaults were handled. API keys and `DATABASE_URL` were passed from the parent test script environment.
    *   Fixed LLM env var passing in `test_dramatiq_worker.py` to ensure defaults were used if parent env vars were empty/None. Re-ran test; still failed (task PENDING).
    *   **Conclusion:** Basic environment differences did not explain the failure.

2.  **`subprocess.Popen` Parameter Tuning:**
    *   Explicitly set `cwd=str(Path(__file__).parent)` in `subprocess.Popen` call in `test_dramatiq_worker.py`. Re-ran test; still failed.
    *   Switched from copying `os.environ` to creating a minimal `worker_env` dictionary containing only essential variables (`PATH`, `HOME`, `LANG`, `TERM`, `DATABASE_URL`, `RABBITMQ_URL`, LLM vars, API keys) and a carefully constructed `PYTHONPATH`. Fixed an `AttributeError` (`sys.version_major`) during implementation. Re-ran test; still failed.
    *   **Conclusion:** Tuning `cwd` and using a minimal environment did not resolve the issue.

3.  **Enhanced Dramatiq/Pika Logging & Import Timing:**
    *   Set root logger level to `DEBUG` in `ops-core/src/ops_core/tasks/worker.py`.
    *   Added detailed `INFO` level timing logs around imports and key function definitions within `ops-core/src/ops_core/scheduler/engine.py`.
    *   Re-ran `test_dramatiq_worker.py`.
    *   **Analysis:** The detailed logs in the worker's stderr revealed that the significant delay (~3-30+ seconds depending on the run) occurs *during* the import of `ops_core.scheduler.engine` within `worker.py`, specifically *after* the `worker.py` logs "Importing engine..." and *before* it logs "Engine imported: ...". The `get_...` functions within `engine.py` were confirmed *not* to be called during this import phase. This pointed to an issue within the module loading/initialization process itself when run as a subprocess.

4.  **Simplified Worker Test Case:**
    *   Created `minimal_worker.py` with a basic Dramatiq actor and broker setup.
    *   Created `test_minimal_worker.py` to launch the minimal worker via `subprocess.Popen` (using minimal env) and send a message.
    *   Fixed `AttributeError: module 'dramatiq' has no attribute 'RabbitmqBroker'` in `minimal_worker.py` by adding the correct import (`from dramatiq.brokers.rabbitmq import RabbitmqBroker`).

**Current Status:** Ready to execute `test_minimal_worker.py` to see if the minimal case reproduces the failure. Task 7.2 remains **Blocked**.