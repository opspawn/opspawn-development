# Debug Log: Task 7.2 - Subprocess Invocation Investigation (2025-04-13 Session 2)

**Objective:** Diagnose why the Dramatiq worker fails to process messages when launched via `subprocess.Popen` from test scripts/fixtures, but works when run via `tox exec`.

**Plan:** Follow steps outlined in `PLANNING_step_7.2.5_subprocess_debug.md`.

**Steps Taken & Findings (Session 2):**

1.  **Environment & Context Comparison:**
    *   Added detailed environment logging (env vars, python path, cwd, uid/gid) to `ops-core/src/ops_core/tasks/worker.py` startup.
    *   Improved subprocess stdout/stderr capture in `test_dramatiq_worker.py`.
    *   Ran worker via `tox exec` and captured logs.
    *   Ran worker via `test_dramatiq_worker.py` (using `tox exec`) and captured logs.
    *   **Comparison:** Core environment (Python exe, path, CWD, user) identical. Key difference was environment variables passed: `test_dramatiq_worker.py` correctly removed `DRAMATIQ_TESTING` but initially passed empty strings for LLM config vars due to how `os.getenv` defaults were handled. API keys and `DATABASE_URL` were passed from the parent test script environment.
    *   Fixed LLM env var passing in `test_dramatiq_worker.py` to ensure defaults were used if parent env vars were empty/None. Re-ran test; still failed (task PENDING).
    *   **Conclusion:** Basic environment differences did not explain the failure.

2.  **`subprocess.Popen` Parameter Tuning:**
    *   Explicitly set `cwd=str(Path(__file__).parent)` in `subprocess.Popen` call in `test_dramatiq_worker.py`. Re-ran test; still failed.
    *   Switched from copying `os.environ` to creating a minimal `worker_env` dictionary containing only essential variables (`PATH`, `HOME`, `LANG`, `TERM`, `DATABASE_URL`, `RABBITMQ_URL`, LLM vars, API keys) and a carefully constructed `PYTHONPATH`. Fixed an `AttributeError` (`sys.version_major`) during implementation. Re-ran test; still failed.
    *   **Conclusion:** Tuning `cwd` and using a minimal environment did not resolve the issue.

3.  **Enhanced Dramatiq/Pika Logging & Import Timing:**
    *   Set root logger level to `DEBUG` in `ops-core/src/ops_core/tasks/worker.py`.
    *   Added detailed `INFO` level timing logs around imports and key function definitions within `ops-core/src/ops_core/scheduler/engine.py`.
    *   Re-ran `test_dramatiq_worker.py`.
    *   **Analysis:** The detailed logs in the worker's stderr revealed that the significant delay (~3-30+ seconds depending on the run) occurs *during* the import of `ops_core.scheduler.engine` within `worker.py`, specifically *after* the `worker.py` logs "Importing engine..." and *before* it logs "Engine imported: ...". The `get_...` functions within `engine.py` were confirmed *not* to be called during this import phase. This pointed to an issue within the module loading/initialization process itself when run as a subprocess.

4.  **Simplified Worker Test Case:**
    *   Created `minimal_worker.py` with a basic Dramatiq actor and broker setup.
    *   Created `test_minimal_worker.py` to launch the minimal worker via `subprocess.Popen` (using minimal env) and send a message.
    *   Fixed `AttributeError: module 'dramatiq' has no attribute 'RabbitmqBroker'` in `minimal_worker.py` by adding the correct import (`from dramatiq.brokers.rabbitmq import RabbitmqBroker`).

**Current Status (End of Session 2):** Ready to execute `test_minimal_worker.py` to see if the minimal case reproduces the failure. Task 7.2 remains **Blocked**.

---

## Debugging Steps (2025-04-13 Session 3)

**Objective:** Execute the minimal worker test case and further isolate the message processing failure.

**Steps Taken & Findings:**

1.  **Execute Minimal Test (`test_minimal_worker.py`):** Ran the simplified worker via `subprocess.Popen` from the test script (`tox exec -e py312 -- python test_minimal_worker.py`).
    *   **Finding:** The minimal worker started but **failed** to process the message (actor logs were missing), similar to the full worker. This indicated the issue wasn't solely due to the complexity of `ops-core` imports. The problem seemed related to message consumption when launched via `subprocess.Popen`.

2.  **Added Actor Logging:** Added `logger.info` calls inside the `simple_task` actor in `minimal_worker.py` to confirm entry.
    *   **Finding:** Re-running the minimal test still showed no actor logs, confirming the actor function wasn't being entered.

3.  **Enabled DEBUG Logging (Pika/Dramatiq):** Increased logging verbosity in `minimal_worker.py`.
    *   **Finding:** Logs showed successful connection/disconnection by worker processes but no message consumption attempts (`Basic.Deliver`, etc.).

4.  **Direct Worker Execution Test:** Ran `minimal_worker.py` directly via `dramatiq` CLI (`tox exec ...`) and sent a message using a modified `send_test_message.py`.
    *   **Finding:** The worker **still failed** to process the message, even when run directly like the full worker. This shifted focus away from `subprocess.Popen` being the primary cause and pointed towards issues with CLI loading/broker interaction within the `tox` environment.

5.  **Simplified Broker Config:** Modified `minimal_worker.py` to remove explicit broker instantiation/setting, relying solely on the CLI argument (`minimal_worker:broker`).
    *   **Finding:** Re-running the direct execution test still resulted in the worker **failing** to process the message.

6.  **Disabled Prometheus Middleware:** Modified `minimal_worker.py` to explicitly define middleware *without* Prometheus to eliminate a previous "Address already in use" error.
    *   **Finding:** Re-running the direct execution test still resulted in the worker **failing** to process the message. The Prometheus error was gone, but the core issue persisted.

7.  **Bypassed `tox exec` for Worker:** Ran the worker directly using the tox environment's python interpreter (`nohup .tox/py312/bin/python -m dramatiq ...`) and sent a message using `send_test_message.py` (via `tox exec`).
    *   **Finding:** The worker **still failed** to process the message. This suggests `tox exec` is likely not the cause either.

**Current Conclusion (End of Session 3):** The root cause seems to be related to how the `minimal_worker.py` module, its actor, or its broker interaction behaves when invoked via the `dramatiq` CLI, regardless of whether it's wrapped by `tox exec` or `subprocess.Popen`. The failure occurs *before* the actor code is executed, despite successful module loading and broker connection indications in the logs. The next step would be to investigate potential environment variable differences when running via CLI vs. direct import, or subtle interactions with Dramatiq's process model. Task 7.2 remains **Blocked**.