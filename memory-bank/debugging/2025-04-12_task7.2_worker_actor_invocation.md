# Debugging Log: Dramatiq Worker Actor Invocation Issue

- **Date & Context:** 2025-04-12 (Evening Session)
- **Task:** [Task 7.2: Execute & Debug Live E2E Tests](../../TASK.md#task-72-execute--debug-live-e2e-tests)
- **Goal:** Diagnose why the `execute_agent_task_actor` is not being invoked by the Dramatiq worker process when running the `test_dramatiq_worker.py` isolation script.

## Initial Symptom

When running `test_dramatiq_worker.py`, the script successfully sends a message to the `execute_agent_task_actor` via RabbitMQ. The worker subprocess starts, initializes, and appears ready. However, the task status in the database remains `PENDING`, and the script eventually times out waiting for completion. Logs indicate the actor function itself is never entered.

## Affected Batch/Area

- Dramatiq message consumption/dispatch within the worker process.
- Interaction between `test_dramatiq_worker.py` (sender) and the worker subprocess (consumer/executor).
- Core files involved:
    - `test_dramatiq_worker.py`
    - `ops-core/src/ops_core/tasks/worker.py` (Worker entry point)
    - `ops-core/src/ops_core/tasks/broker.py` (Broker config)
    - `ops-core/src/ops_core/scheduler/engine.py` (Actor definition & implementation)

## Isolation Command

The primary isolation command used throughout this debugging session:

```bash
# Run from /home/sf2/Workspace/23-opspawn/1-t directory
.tox/py312/bin/python test_dramatiq_worker.py
```
(Flags like `-v`, `-p 1`, `-t 1` were added to the worker invocation *within* the script during debugging).

## Debugging Log (Chronological)

1.  **Timestamp/Step:** ~2025-04-12 9:23 PM - Initial Run after Fixes
    *   **Action:** Ran `test_dramatiq_worker.py` after fixing previous issues (Alembic, DB, planner signature, etc.) and shortening agent timeout to 5s.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Script ran, worker started, task remained `PENDING`, script timed out after polling DB. No errors, but no progress.
    *   **Hypothesis:** Agent timeout (5s) might be too short, or worker isn't picking up the message.

2.  **Timestamp/Step:** ~2025-04-12 9:23 PM - Reduce Script Wait Times
    *   **Action:** Modified `test_dramatiq_worker.py` to reduce `WORKER_STARTUP_WAIT` (5->2s), `TASK_COMPLETION_WAIT` (70->15s), and polling interval (5->1s).
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Faster execution, but same result: task `PENDING`, script timeout.
    *   **Hypothesis:** Script waits aren't the bottleneck. Issue is likely worker/actor execution.

3.  **Timestamp/Step:** ~2025-04-12 9:24 PM - Increase Agent Timeout
    *   **Action:** Modified `ops-core/src/ops_core/scheduler/engine.py` to increase `AGENT_EXECUTION_TIMEOUT` from 5s to 20s.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Same result: task `PENDING`, script timeout. Worker logs show clean startup/shutdown.
    *   **Hypothesis:** Agent timeout isn't the primary issue; the actor code isn't even being reached.

4.  **Timestamp/Step:** ~2025-04-12 9:25 PM - Simplify Actor Registration
    *   **Action:** Modified `ops-core/src/ops_core/scheduler/engine.py` to remove the check (`if _actor_name not in _broker.actors:`) and directly apply the `@dramatiq.actor` decorator.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Same result: task `PENDING`, script timeout.
    *   **Hypothesis:** Actor registration method wasn't the issue.

5.  **Timestamp/Step:** ~2025-04-12 9:26 PM - Add Critical Actor Entry Log
    *   **Action:** Added `logger.critical("!!!!!! ACTOR ENTRY POINT REACHED...")` at the very beginning of `_execute_agent_task_actor_impl` in `engine.py`. Fixed resulting syntax errors.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Same result: task `PENDING`, script timeout. **Crucially, the critical log message did NOT appear in the worker's STDERR.**
    *   **Hypothesis:** Confirmed the actor function is *never* being called by the worker process. The issue is in message consumption or dispatch.

6.  **Timestamp/Step:** ~2025-04-12 9:27 PM - Simplify Worker Command (Attempt 1)
    *   **Action:** Modified `test_dramatiq_worker.py` worker command to remove explicit broker path (`ops_core.tasks.broker:broker`), leaving only `ops_core.tasks.worker`.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Worker failed to start (`ModuleNotFoundError: No module named 'ops-core/src/ops_core/tasks/worker'`).
    *   **Hypothesis:** Dramatiq CLI requires module path, not file path.

7.  **Timestamp/Step:** ~2025-04-12 9:29 PM - Revert Worker Command
    *   **Action:** Reverted worker command in `test_dramatiq_worker.py` back to using module path `ops_core.tasks.worker`.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Worker started, task `PENDING`, no critical log. (Back to previous state).
    *   **Hypothesis:** Worker command structure wasn't the issue.

8.  **Timestamp/Step:** ~2025-04-12 9:30 PM - Add Broker Type Log
    *   **Action:** Added `print("!!! BROKER CONFIGURED: ...")` statements in `ops-core/src/ops_core/tasks/broker.py`.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Worker STDERR showed `!!! BROKER CONFIGURED: RabbitmqBroker !!!`. Task `PENDING`, no critical actor log.
    *   **Hypothesis:** Worker subprocess is correctly identifying and configuring the RabbitMQ broker.

9.  **Timestamp/Step:** ~2025-04-12 9:31 PM - Force Single Process/Thread
    *   **Action:** Added `-p 1 -t 1` flags to worker command in `test_dramatiq_worker.py`.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Worker started with 1 process/thread (visible in verbose logs). Task `PENDING`, no critical actor log.
    *   **Hypothesis:** Worker concurrency model isn't the issue.

10. **Timestamp/Step:** ~2025-04-12 9:31 PM - Remove AsyncIO Middleware
    *   **Action:** Commented out `broker.add_middleware(AsyncIO())` in `broker.py`.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Task `PENDING`, no critical actor log.
    *   **Hypothesis:** `AsyncIO` middleware isn't preventing initial message dispatch (though it would likely cause errors later if the actor *was* called).

11. **Timestamp/Step:** ~2025-04-12 9:36 PM - Restore AsyncIO, Remove Results Middleware
    *   **Action:** Restored `AsyncIO` middleware, removed `Results` middleware in `broker.py`. Removed diagnostic prints.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py`
    *   **Observation:** Task `PENDING`, no critical actor log.
    *   **Hypothesis:** `Results` middleware isn't the issue.

12. **Timestamp/Step:** ~2025-04-12 9:38 PM - Add Extensive Verbose Logging
    *   **Action:** Added `VERBOSE_LOG:` prefixed logs throughout `test_dramatiq_worker.py`, `worker.py`, and `engine.py`. Updated `testing_strategy.md`.
    *   **Command:** `.tox/py312/bin/python test_dramatiq_worker.py` (after fixing indentation errors from logging additions).
    *   **Observation:** Worker logs confirmed broker type, module imports, and actor discovery (`VERBOSE_LOG: Actor 'execute_agent_task_actor' FOUND...`). Task `PENDING`, no critical actor log.
    *   **Hypothesis:** Worker initialization seems correct up to the point of consuming/dispatching the message.

## Root Cause (TBD)

- Unknown. The worker process appears fully initialized and configured correctly (broker, actor discovery, queue consumption threads started) but fails to invoke the target actor function when a message is sent to the queue it's consuming.

## Solution/Fix (TBD)

- Requires further investigation. Potential next steps:
    - Inspect RabbitMQ management UI to verify message arrival, queue state, and consumer status.
    - Further simplify the actor (e.g., make it synchronous, remove all internal logic) to see if *any* invocation occurs.
    - Investigate potential environment/dependency conflicts specific to the subprocess context.
    - Check Dramatiq/Pika library versions for known issues.

## Verification Steps (TBD)

- Re-run `test_dramatiq_worker.py`.
- Observe worker logs for the `!!!!!! VERBOSE_LOG: ACTOR ENTRY POINT REACHED... !!!!!!` message.
- Observe task status change from `PENDING` to `RUNNING` (and eventually `COMPLETED` or `FAILED`).

## Learnings/Takeaways

- Debugging distributed systems/message queues can be complex.
- Verbose logging is essential but doesn't always pinpoint the issue if the failure occurs within the library's internal dispatch mechanism.
- Isolating components (like using the worker script) is valuable but may still hit roadblocks requiring deeper dives or different isolation approaches.
- The recursive isolation strategy documented in `testing_strategy.md` provides a good framework for tackling such issues.