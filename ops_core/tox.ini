[tox]
envlist = py312  # Align with Python 3.12.9 being used in the environment
isolated_build = True
# skipsdist = True # Removed: Allow tox to build ops-core if needed for path resolution

[testenv]
description = Run ops-core tests with agentkit installed editable
# Install test-specific dependencies and editable packages.
# Project dependencies are pulled via the editable install of ops-core itself.
deps =
    pytest
    pytest-asyncio
    pytest-mock # Added for mocker fixture
    # Explicitly install dramatiq with rabbitmq extras
    dramatiq[rabbitmq]>=1.17.0
    # Install ops-core itself (non-editable)
    .
    # Install agentkit editable from the relative path
    -e ../agentkit
# Run pytest from within the ops_core directory
 # changedir = {toxinidir}/.. # Removed
 # Remove explicit PYTHONPATH setting; rely on editable install
 # Explicitly set PYTHONPATH to include agentkit source for discovery, but NOT the parent dir.
passenv = PYTHONPATH # Pass existing PYTHONPATH through
setenv =
    PYTHONPATH = {toxinidir}/../agentkit:{env:PYTHONPATH:} # Only add agentkit path
allowlist_externals = python, bash # Allow running 'python' and 'bash' commands
commands =
    # 1. Generate gRPC code directly into the renamed grpc_internal package directory
    python -m grpc_tools.protoc -I{toxinidir}/.tox/py/lib/python3.12/site-packages -I{toxinidir}/ops_core/proto --python_out={toxinidir}/ops_core/grpc_internal --grpc_python_out={toxinidir}/ops_core/grpc_internal {toxinidir}/ops_core/proto/tasks.proto
    # 2. Re-enable the fix script to apply relative import
    bash {toxinidir}/scripts/fix_grpc_imports.sh
    # 3. Run tests (Removed diagnostic commands)
    python -m pytest tests/
